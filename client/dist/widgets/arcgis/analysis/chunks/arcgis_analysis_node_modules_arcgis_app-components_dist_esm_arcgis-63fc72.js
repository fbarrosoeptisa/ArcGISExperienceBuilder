/*! For license information please see arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-63fc72.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-63fc72"],{19780:(e,t,i)=>{i.r(t),i.d(t,{arcgis_field_delete:()=>d});var l=i(19564),s=i(9421),a=i(66507),o=i(98034),r=i(44508),n=i(72300);i(12350),i(91102),i(73807),i(89261),i(99004),i(4948),i(18991),i(67336);const d=class{constructor(e){(0,l.r)(this,e),this.arcgisFieldDeleteFieldDeleted=(0,l.c)(this,"arcgisFieldDeleteFieldDeleted",7),this.arcgisFieldDeleteModalClose=(0,l.c)(this,"arcgisFieldDeleteModalClose",7),this.arcgisFieldDeleteBeforeModalClose=(0,l.c)(this,"arcgisFieldDeleteBeforeModalClose",7),this.layerFields=[],this.layerFieldsMap=new Map,this.arcadeExpMap=new Map,this.fieldsAreDeletable=!1,this.layer=void 0,this.fieldNames=void 0,this.config=void 0,this.mapView=void 0,this.options=void 0,this.deleteInProgress=!1,this.currentLayerInfo=void 0}async componentWillLoad(){var e,t,i;const{layer:l,mapView:o,fieldNames:r}=this,[d]=await(0,a.g)(this.hostElement);this.strings=d,this.layer=l.loaded?l:await l.load(),this.layerFields=l.fields.filter((e=>r.includes(e.name))),this.fieldsAreDeletable=this.layerFields.every((async e=>await(0,n.a)(o,l,e))),this.fieldsAreDeletable&&(await this.loadAllModules(),this.layerFieldsMap=await(0,s.e)(l),this.arcadeExpMap=(0,s.f)(l.popupTemplate),this.portal=null!==(t=null===(e=l.portalItem)||void 0===e?void 0:e.portal)&&void 0!==t?t:this.options.portal,this.item=null!==(i=l.portalItem)&&void 0!==i?i:this.options.item,await this.modules.IdentityManager.getCredential(l.portalItem.url.replace("rest/services","rest/admin/services")))}render(){const{strings:e,fieldsAreDeletable:t,fieldNames:i,deleteInProgress:s}=this;return t?(0,l.h)(l.H,null,(0,l.h)("calcite-dialog",{class:"dialog "+(s?"delete-in-progress-dialog":""),widthScale:"s",ref:e=>this.dialogNode=e,open:!0,modal:!0,outsideCloseDisabled:!0,escapeDisabled:!0,onCalciteDialogClose:()=>this.arcgisFieldDeleteModalClose.emit(),heading:1===i.length?e.deleteField:e.deleteFields},(0,l.h)("div",{class:"dialog-content-wrapper "+(s?"hide-overflow":"")},this.renderDeleteLoader(),(0,l.h)("calcite-label",null,1===i.length?e.deletePrompt:e.deleteMultiplePrompt),this.renderFieldsPreview()),this.renderCancelButton(),this.renderDeleteButton())):(1===i.length?console.error("Field cannot be deleted"):console.error("One or more fields cannot be deleted"),(0,l.h)(l.F,null))}renderDeleteLoader(){const{strings:e,fieldNames:t,deleteInProgress:i}=this;return(0,l.h)("div",{class:"loader-container "+(i?"active":"")},(0,l.h)("calcite-loader",{class:"loader",label:1===t.length?e.deletingField:e.deletingFields,hidden:!i}),(0,l.h)("div",{class:"loader-text"},1===t.length?e.deletingField:e.deletingFields))}renderFieldsPreview(){const{fieldNames:e,layerFields:t,layerFieldsMap:i,arcadeExpMap:a,strings:o}=this;return(0,l.h)("calcite-list",{label:o.fields},e.map((e=>{const o=t.find((t=>t.name===e));return(0,l.h)("calcite-list-item",{label:this.getFieldLabel(e),description:`{${e}}`,value:e,disabled:!o.editable},(0,l.h)("div",{slot:"actions-end",class:"field-icons"},(0,l.h)(n.F,{fieldType:(0,s.b)(e,i,a)})))})))}renderCancelButton(){const{strings:e}=this;return(0,l.h)("calcite-button",{onClick:()=>this.dialogNode.open=!1,slot:"footer-end",appearance:"outline",ref:e=>this.cancelNode=e},e.cancel)}renderDeleteButton(){const{strings:e,fieldNames:t}=this;return(0,l.h)("calcite-button",{kind:"danger",slot:"footer-end",onClick:async e=>{e.target.disabled=!0,this.cancelNode.disabled=!0,this.dialogNode.closeDisabled=!0,this.deleteInProgress=!0,await this.deleteFields()}},1===t.length?e.deleteField:e.deleteFieldsWithNumber.replace("${number}",`${t.length}`))}async loadAllModules(){const[e,t,i,l,s]=await(0,o.l)(["esri/request","esri/layers/support/FeatureTemplate","esri/Graphic","esri/layers/support/fieldUtils","esri/identity/IdentityManager"]);this.modules={request:e,FeatureTemplate:t,Graphic:i,fieldUtils:l,IdentityManager:s}}getFieldLabel(e){var t,i;const{layer:l,arcadeExpMap:a}=this,o=null===(i=(null!==(t=l.popupTemplate)&&void 0!==t?t:l.createPopupTemplate()).fieldInfos)||void 0===i?void 0:i.find((t=>t.fieldName===e));return(0,s.c)(o,a)}async deleteFields(){const{layer:e,modules:t,fieldNames:i}=this,{request:l}=t,s=`${e.url.replace("/rest/services","/rest/admin/services")}/${e.layerId}/deleteFromDefinition`,a={fields:i.map((e=>({name:e})))},o={deleteFromDefinition:JSON.stringify(a)};await l(s,{query:Object.assign(Object.assign({},o),{f:"json",async:!1}),method:"post",responseType:"json"}).then((async t=>{var s;if(null===(s=t.data)||void 0===s?void 0:s.success){const t=`${e.url}/${e.layerId}`;i.forEach((t=>{var i;"feature"===e.type&&(null===(i=e.floorInfo)||void 0===i?void 0:i.floorField)===t&&(e.floorInfo=null)})),await l(t,{query:{f:"json"},responseType:"json"}).then((async e=>{const t=e.data;this.currentLayerInfo=e.data,t&&(this.updateTypesAndTemplatesOnLayer(),i.forEach((e=>{var i;(null===(i=t.templates)||void 0===i?void 0:i.length)?t.templates.forEach((t=>{delete t.prototype.attributes[e]})):t.types.forEach((t=>{t.templates.forEach((t=>{delete t.prototype.attributes[e]}))}))})),this.updateFeatureService(t,l))}))}}),(()=>this.handleError()))}updateTypesAndTemplatesOnLayer(){var e;const{currentLayerInfo:t}=this,i=t;if(null===(e=i.templates)||void 0===e?void 0:e.length){const e=this.updateTemplatesList(i.templates);i.templates=e}else if(i.types){const e=i.types;i.types=[],e.forEach((e=>{e.templates=this.updateTemplatesList(e.templates),this.addType(i,e)}))}}updateTemplatesList(e){const{currentLayerInfo:t,modules:i,strings:l}=this,s=[];return(null!=e?e:[]).forEach((e=>{var a;const o=new i.FeatureTemplate;o.description=null!==(a=e.description)&&void 0!==a?a:"",o.name=e.name||l.newFeature,o.drawingTool=e.drawingTool||"point";const r={};t.fields.forEach((t=>{let i=!1;for(const l in e.prototype.attributes)if(l===t.name){i=!0,r[t.name]=e.prototype.attributes[t.name];break}!i&&t.editable&&(r[t.name]=t.defaultValue||null)}));const n=new i.Graphic({attributes:r});o.prototype=n,s.push(o)})),s}addType(e,t){if(e.types){e.types.some((e=>e.id===t.id))||e.types.push(t)}else e.types=[t]}async updateFeatureService(e,t){const{layer:i,fieldNames:l}=this,s={templates:e.templates,types:e.types},a=`${i.url.replace("/rest/services","/rest/admin/services")}/${i.layerId}/updateDefinition`,o={f:"json",updateDefinition:JSON.stringify(s)};await t(a,{query:Object.assign(Object.assign({},o),{f:"json"}),method:"post",responseType:"json"}).then((async e=>{var s;if(null===(s=e.data)||void 0===s?void 0:s.success){const e=`${(0,r.g)(this.portal)}content/items/${this.item.id}/data`;if(l.forEach((e=>{var t,l,s;(null===(t=i.popupTemplate)||void 0===t?void 0:t.fieldInfos)&&(i.popupTemplate.fieldInfos=i.popupTemplate.fieldInfos.filter((t=>t.fieldName!==e))),null===(s=null===(l=i.popupTemplate)||void 0===l?void 0:l.content)||void 0===s||s.forEach(((t,l)=>{var s,a,o;"fields"===t.type&&t.fieldInfos&&((null===(s=i.popupTemplate)||void 0===s?void 0:s.content)[l].fieldInfos=null===(o=(null===(a=i.popupTemplate)||void 0===a?void 0:a.content)[l].fieldInfos)||void 0===o?void 0:o.filter((t=>t.fieldName!==e)))}))})),i.attributeTableTemplate){const e=i.attributeTableTemplate.clone();e.elements=e.elements.filter((e=>!("field"===e.type&&l.includes(e.fieldName)))),e.orderByFields=e.orderByFields.filter((e=>!l.includes(e.field))),i.attributeTableTemplate=e}await t(e,{query:{f:"json"},method:"get",responseType:"json"}).then((async e=>{var s;const a=e.data;if((null==a?void 0:a.layers)||(null==a?void 0:a.tables)){const e=i.isTable,o=e?a.tables:a.layers,n=null==o?void 0:o.find((e=>e.id===i.layerId));if(l.forEach((e=>{var t;(null===(t=null==n?void 0:n.attributeTableInfo)||void 0===t?void 0:t.attributeTableElements)&&(n.attributeTableInfo.attributeTableElements=n.attributeTableInfo.attributeTableElements.filter((t=>!("field"===t.type&&t.fieldName===e))),n.attributeTableInfo.orderByFields=n.attributeTableInfo.orderByFields.filter((t=>t.field!==e)))})),null==n?void 0:n.popupInfo){l.forEach((e=>{var t;n.popupInfo.fieldInfos=n.popupInfo.fieldInfos.filter((t=>t.fieldName!==e)),null===(t=n.popupInfo.popupElements)||void 0===t||t.forEach(((t,i)=>{"fields"===t.type&&t.fieldInfos&&(n.popupInfo.popupElements[i].fieldInfos=n.popupInfo.popupElements[i].fieldInfos.filter((t=>t.fieldName!==e)))}))}));const i=`${(0,r.g)(this.portal)}content/users/${this.item.owner}/items/${this.item.id}/update`,a={};e?a.tables=o:a.layers=o;const d={f:"json",text:JSON.stringify(a)},{portal:c}=this;(null===(s=c.sourceJSON)||void 0===s?void 0:s.isReadOnly)?this.handleError(!0):await t(i,{query:Object.assign({f:"json"},d),method:"post",responseType:"json"}).then((e=>{var t;(null===(t=e.data)||void 0===t?void 0:t.success)?this.handleSuccess():this.handleError()}),(()=>this.handleError()))}else this.handleSuccess()}else 200!==e.httpStatus||e.data&&"{}"!==JSON.stringify(e.data)?this.handleError():this.handleSuccess()}),(()=>this.handleError()))}}),(()=>this.handleError()))}handleSuccess(){var e;this.arcgisFieldDeleteFieldDeleted.emit(),this.dialogNode.open=!1,(null===(e=this.options)||void 0===e?void 0:e.handleCloseOnConsumer)?this.arcgisFieldDeleteBeforeModalClose.emit("success"):this.displaySuccessAlert()}handleError(e){var t,i;this.dialogNode.open=!1,e?(this.arcgisFieldDeleteFieldDeleted.emit(),(null===(t=this.options)||void 0===t?void 0:t.handleCloseOnConsumer)?this.arcgisFieldDeleteBeforeModalClose.emit("read-only-error"):this.displayReadOnlyErrorAlert()):(null===(i=this.options)||void 0===i?void 0:i.handleCloseOnConsumer)?this.arcgisFieldDeleteBeforeModalClose.emit("error"):this.displayErrorAlert()}displaySuccessAlert(){var e;const{strings:t,fieldNames:i}=this;this.successAlertNode&&(null===(e=this.successAlertNode.parentElement)||void 0===e||e.removeChild(this.successAlertNode),this.successAlertNode=null);const l=this.successAlertNode=document.createElement("calcite-alert");l.kind="success",l.icon="check-circle";const s=document.createElement("div");s.slot="message",s.innerHTML=1===i.length?t.fieldDeleted:t.fieldsDeleted,l.append(s),l.open=!0,l.autoClose=!0,document.body.append(l)}displayErrorAlert(){var e;const{strings:t}=this;this.errorAlertNode&&(null===(e=this.errorAlertNode.parentElement)||void 0===e||e.removeChild(this.errorAlertNode),this.errorAlertNode=void 0);const i=this.errorAlertNode=document.createElement("calcite-alert");i.kind="danger",i.icon="exclamation-mark-triangle";const l=document.createElement("div");l.slot="message",l.innerHTML=t.fieldDeletionUnsuccessful,i.append(l),i.open=!0,i.autoClose=!0,document.body.append(i)}displayReadOnlyErrorAlert(){var e;const{strings:t,layer:i}=this;this.errorAlertNode&&(null===(e=this.errorAlertNode.parentElement)||void 0===e||e.removeChild(this.errorAlertNode),this.errorAlertNode=void 0);const l=this.errorAlertNode=document.createElement("calcite-alert");l.kind="danger",l.autoCloseDuration="slow",l.icon="exclamation-mark-triangle";const s=document.createElement("div");s.slot="title",s.innerHTML=t.savingFailed.replace("${layerName}",i.title);const a=document.createElement("div");a.slot="message",a.innerHTML=t.readOnlyErrorMessage;const o=document.createElement("calcite-link");o.slot="link",o.innerHTML=t.healthDashboard,o.href="https://status.arcgis.com",o.target="_blank",l.open=!0,l.autoClose=!0,l.appendChild(s),l.appendChild(a),l.appendChild(o),document.body.append(l)}get hostElement(){return(0,l.d)(this)}};d.style=".dialog{--calcite-dialog-max-size-y:90%}.delete-in-progress-dialog{--calcite-dialog-background-color:var(--arcgis-app-background)}.dialog-content-wrapper{position:relative;min-height:100px}.hide-overflow{overflow:hidden}.field-icons{padding:0 var(--arcgis-app-cap-spacing);display:flex;align-items:center}.warning{border-bottom:1px solid var(--calcite-color-border-3);margin-bottom:12px}.warning-message{font-size:var(--calcite-font-size--1);font-weight:var(--calcite-font-weight-bold)}.loader-container{position:absolute;top:0px;right:0px;z-index:40;display:none;height:100%;width:100%;overflow:hidden;background:rgba(255, 255, 255, 0.95);padding:0px}.active{display:flex;flex-direction:column;place-content:center;align-items:center;justify-items:center}.loader{padding:0px}.loader-text{text-align:center;font-size:1rem;font-weight:500;margin-right:6.25rem;margin-left:6.25rem}"}}]);