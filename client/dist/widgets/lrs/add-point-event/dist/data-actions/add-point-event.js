System.register(["jimu-core","widgets/shared-code/lrs"],(function(e,t){var r={},n={};return{setters:[function(e){r.AbstractDataAction=e.AbstractDataAction,r.DataLevel=e.DataLevel,r.DataSourceStatus=e.DataSourceStatus,r.DataSourceTypes=e.DataSourceTypes,r.MutableStoreManager=e.MutableStoreManager,r.getAppStore=e.getAppStore,r.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){n.QueryRouteMeasures=e.QueryRouteMeasures,n.getDateWithTZOffset=e.getDateWithTZOffset,n.getRouteFromEndMeasures=e.getRouteFromEndMeasures,n.isDefined=e.isDefined,n.queryRouteIdOrName=e.queryRouteIdOrName}],execute:function(){e((()=>{var e={79244:e=>{"use strict";e.exports=r},47626:e=>{"use strict";e.exports=n}},t={};function o(r){var n=t[r];if(void 0!==n)return n.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,o),i.exports}o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.p="";var i={};return o.p=window.jimuConfig.baseUrl,(()=>{"use strict";o.r(i),o.d(i,{default:()=>Z});const e="object"==typeof global&&global&&global.Object===Object&&global;var t="object"==typeof self&&self&&self.Object===Object&&self;const r=e||t||Function("return this")();var n=/\s/;const a=function(e){for(var t=e.length;t--&&n.test(e.charAt(t)););return t};var u=/^\s+/;const s=function(e){return e?e.slice(0,a(e)+1).replace(u,""):e};const l=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};const c=r.Symbol;var d=Object.prototype,f=d.hasOwnProperty,v=d.toString,p=c?c.toStringTag:void 0;const g=function(e){var t=f.call(e,p),r=e[p];try{e[p]=void 0;var n=!0}catch(e){}var o=v.call(e);return n&&(t?e[p]=r:delete e[p]),o};var y=Object.prototype.toString;const m=function(e){return y.call(e)};var S=c?c.toStringTag:void 0;const D=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":S&&S in Object(e)?g(e):m(e)};const b=function(e){return null!=e&&"object"==typeof e};const h=function(e){return"symbol"==typeof e||b(e)&&"[object Symbol]"==D(e)};var O=/^[-+]0x[0-9a-f]+$/i,N=/^0b[01]+$/i,I=/^0o[0-7]+$/i,M=parseInt;const j=function(e){if("number"==typeof e)return e;if(h(e))return NaN;if(l(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=l(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=s(e);var r=N.test(e);return r||I.test(e)?M(e.slice(2),r?2:8):O.test(e)?NaN:+e};var w=1/0;const A=function(e){return e?(e=j(e))===w||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0};const P=function(e){var t=A(e),r=t%1;return t==t?r?t-r:t:0};const R=function(e,t){for(var r=-1,n=null==e?0:e.length,o=Array(n);++r<n;)o[r]=t(e[r],r,e);return o};const F=Array.isArray;var L=c?c.prototype:void 0,T=L?L.toString:void 0;const x=function e(t){if("string"==typeof t)return t;if(F(t))return R(t,e)+"";if(h(t))return T?T.call(t):"";var r=t+"";return"0"==r&&1/t==-1/0?"-0":r};const k=function(e){return null==e?"":x(e)};var E=r.isFinite,_=Math.min;const J=function(e){var t=Math[e];return function(e,r){if(e=j(e),(r=null==r?0:_(P(r),292))&&E(e)){var n=(k(e)+"e").split("e"),o=t(n[0]+"e"+(+n[1]+r));return+((n=(k(o)+"e").split("e"))[0]+"e"+(+n[1]-r))}return t(e)}}("round");var C=o(79244),G=o(47626),W=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function u(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,u)}s((n=n.apply(e,t||[])).next())}))};class Z extends C.AbstractDataAction{isSupported(e,t){return W(this,void 0,void 0,(function*(){var r;if(e.length>1)return!1;const n=e[0],o=n.records[0];if(!(0,G.isDefined)(o))return!1;const i=o.getData(),a=JSON.parse(JSON.stringify(i)),{dataSource:u,records:s}=n,l=u.type===C.DataSourceTypes.FeatureLayer||u.type===C.DataSourceTypes.SceneLayer,c=u.isDataSourceSet(),d=t!==C.DataLevel.Records,f=n.dataSource,v=(null==f?void 0:f.supportSpatialInfo)&&(null==f?void 0:f.supportSpatialInfo()),p=t===C.DataLevel.Records&&0===(null==s?void 0:s.length),g=!u.isInAppConfig()&&!l;if(c||d||p||g||!v)return!1;let y=u;if((u.id.includes("output_point")||u.id.includes("output_line"))&&(y=u.getOriginDataSources()[0]),!(0,G.isDefined)(y))return!1;const m=q(),S=null===(r=null==m?void 0:m.widgets)||void 0===r?void 0:r[this.widgetId];let D,b;if(S.config.lrsLayers.forEach((e=>{(0,G.isDefined)(y)&&e.id===y.id&&(D=e.networkInfo)})),!D)return!1;if(!(0,G.isDefined)(D.eventLayers)||0===D.eventLayers.length)return!1;const h=D.eventLayers;if(S.config.lrsLayers.forEach((e=>{h.forEach((t=>{String(e.originName)===t&&(b=e.eventInfo)}))})),!b)return!1;const O=Object.keys(a).find((e=>e===D.routeIdFieldSchema.name));if(!(0,G.isDefined)(O)||!(0,G.isDefined)(a[O]))return!1;if(n.records.length>1)return!1;let N=!1;const I=u.id;return(I.includes("output_point")||I.includes("output_line"))&&(N=!0),(!N||1===n.records.length)&&!(!u||u.getStatus()===C.DataSourceStatus.NotReady)}))}onExecute(e,t){return W(this,void 0,void 0,(function*(){var t;const r=e[0],{records:n,dataSource:o}=r,i=q(),a=null===(t=null==i?void 0:i.widgets)||void 0===t?void 0:t[this.widgetId];let u,s=o;if((o.id.includes("output_point")||o.id.includes("output_line"))&&(s=o.getOriginDataSources()[0]),!(0,G.isDefined)(s))return!1;a.config.lrsLayers.forEach((e=>{(0,G.isDefined)(s)&&e.id===s.id&&(u=e.networkInfo)}));const l=n[0],c=l.getData(),d=JSON.parse(JSON.stringify(c)),f=Object.fromEntries(Object.entries(d).map((([e,t])=>[e.toLowerCase(),t]))),v={routeId:"",routeName:"",fromMeasure:NaN,toMeasure:NaN,fromDate:void 0,toDate:void 0,selectedMeasure:NaN,selectedFromDate:void 0,selectedToDate:void 0},p=Object.keys(d).find((e=>e===u.routeIdFieldSchema.name)),g=Object.keys(d).find((e=>{var t;return e===(null===(t=u.routeNameFieldSchema)||void 0===t?void 0:t.name)})),y=Object.keys(d).find((e=>e===u.fromDateFieldSchema.name)),m=Object.keys(d).find((e=>e===u.toDateFieldSchema.name)),S=Object.keys(d).find((e=>{var t;return e===(null===(t=u.lineIdFieldSchema)||void 0===t?void 0:t.name)})),D=Object.keys(d).find((e=>{var t;return e===(null===(t=u.lineOrderFieldSchema)||void 0===t?void 0:t.name)})),b=(0,G.isDefined)(d[y])?(0,G.getDateWithTZOffset)(d[y],s):null,h=(0,G.isDefined)(d[m])?(0,G.getDateWithTZOffset)(d[m],s):null;if(v.fromDate=b,v.selectedFromDate=b,v.toDate=h,v.selectedToDate=h,v.routeId=(0,G.isDefined)(d[p])?String(d[p]):null,v.routeName=(0,G.isDefined)(d[g])?String(d[g]):null,v.lineId=(0,G.isDefined)(d[S])?String(d[S]):null,v.routeLineOrder=(0,G.isDefined)(d[D])?Number(d[D]):null,v.fromMeasure=(0,G.isDefined)(f.measure)?Number(f.measure):NaN,v.selectedMeasure=(0,G.isDefined)(f.measure)?Number(f.measure):NaN,v.validRoute=!0,(0,G.isDefined)(d.Measure)){let e=null,t=null;yield(0,C.loadArcGISJSAPIModules)(["esri/geometry/Point","esri/geometry/Polyline"]).then((r=>{[e,t]=r})).then((()=>{const r=l.getRawGeometry();if("point"===r.type){const t=new e(r);v.selectedPoint=t}else if("polyline"===r.type){const e=new t(r).getPoint(0,0);v.selectedPoint=e}}))}let O=null;if((0,G.isDefined)(u)){const e=u.useRouteName?v.routeName:v.routeId;yield(0,G.queryRouteIdOrName)(e.trim(),u,s,!1,!0,"",v.fromDate).then((e=>W(this,void 0,void 0,(function*(){if((0,G.isDefined)(e)&&(yield Promise.all(e.features.map((e=>W(this,void 0,void 0,(function*(){O=e.geometry}))))),(0,G.isDefined)(O))){v.selectedPolyline=O;const e=(0,G.getRouteFromEndMeasures)(O);if((0,G.isDefined)(e)){const t=yield(0,G.QueryRouteMeasures)(s,u,e,v.fromDate,v.routeId),r=Math.min(...t),n=Math.max(...t);v.fromMeasure=J(r,u.measurePrecision),v.toMeasure=J(n,u.measurePrecision)}}}))))}return C.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedNetworkDataSource",s),C.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedRouteInfo",v),!0}))}}function q(){var e,t,r;return window.jimuConfig.isBuilder?null===(t=null===(e=(0,C.getAppStore)().getState())||void 0===e?void 0:e.appStateInBuilder)||void 0===t?void 0:t.appConfig:null===(r=(0,C.getAppStore)().getState())||void 0===r?void 0:r.appConfig}})(),i})())}}}));